@page "/show-payment/{id:int}"
@model ShowPaymentModel
@{
    var payment = Model.Payment;
    var invoice = Model.Invoice;
}

@section Meta {
    <title>
        Betalning - @(Branding.WebsiteTitle)
    </title>
}

@section Header {
    <partial name="_Navbar" model="Model.UserToken" />
}

@await Html.PartialAsync("/Pages/Clients/_Shared/_Payment.cshtml", Model.UserToken)

<main>

    <h4>
        Betalning
    </h4>

    <figure>
        <table>
            <tr>
                <th>Datum</th>
                <th class="end-align">Belopp</th>
                <th>Konto</th>
                <th>Referens</th>
            </tr>
            <tr>
                <td>
                    @(payment.Date.ToIso8601())
                </td>
                <td class="end-align">
                    @(payment.Amount.ToSwedish())
                </td>
                <td>
                    @(payment.PaymentAccount?.Name ?? "-")
                </td>
                <td>
                    @(payment.Reference ?? "-")
                </td>
            </tr>
        </table>
    </figure>

    @if (invoice == null)
    {
        <br />

        <div class="notice">
            Betalningen är inte knuten till någon faktura.
        </div>
    }

    @if (invoice != null)
    {
        <br />

        <h5>Faktura</h5>

        <figure>
            <table>
                <tr>
                    <th>Nummer</th>
                    <th>Fakturadatum</th>
                    <th>Mottagare</th>
                    <th class="end-align">Belopp</th>
                </tr>
                <tr>
                    <td>
                        <a href="/show-invoice/@(invoice.Id)">
                            @(invoice.InvoiceNumber?.ToSwedish() ?? "-")
                        </a>
                    </td>
                    <td>
                        <a href="/show-invoice/@(invoice.Id)">
                            @(invoice.InvoiceDate.ToIso8601())
                        </a>
                    </td>
                    <td>
                        <a href="/show-invoice/@(invoice.Id)">
                            @(invoice.Customer_Name ?? "-")
                        </a>
                    </td>
                    <td class="end-align">
                        <a href="/show-invoice/@(invoice.Id)">
                            @(invoice.Total.ToSwedish())
                        </a>
                    </td>
                </tr>
            </table>
        </figure>
    }
    
    @if (Model.PaymentAccountingRows.Count > 0)
    {
        <br />

        <h5>Kontering</h5>

        <figure>
            <table>
                <tr>
                    <th>Konto</th>
                    <th class="end-align">Debet</th>
                    <th class="end-align">Kredit</th>
                </tr>
                @foreach (var row in Model.PaymentAccountingRows)
                {
                    <tr>
                        <td>
                            @(row.Account ?? "Okänt")
                        </td>
                        <td class="end-align">
                            @(row.Debit.ToSwedish())
                        </td>
                        <td class="end-align">
                            @(row.Credit.ToSwedish())
                        </td>
                    </tr>
                }
            </table>
        </figure>

        <br />
    }

    <div role="toolbar" aria-label="Åtgärder">
        <div role="group">
            @if (Model.Payment.InvoiceId == null)
            {
                <a class="button" href="/assign-payment/@(Model.Payment.Id)">
                    Knyt till faktura
                </a>
            }
            @if (Model.Payment.InvoiceId.HasValue)
            {
                <a class="button" href="/unassign-payment/@(Model.Payment.Id)">
                    Frigör från faktura
                </a>
            }
        </div>
        @if (Model.Payment.InvoiceId == null)
        {
            <div role="group">
                <a class="button" href="/edit-payment/@(Model.Payment.Id)">
                    Redigera
                </a>

                <a class="button" href="/remove-payment/@(Model.Payment.Id)">
                    Ta bort
                </a>
            </div>
        }
        @if (Model.UserToken.IsAdmin)
        {
            <div role="group">
                <a class="button admin" href="/update-payment-accounting-rows/@(Model.Payment.Id)">
                    Skapa kontering
                </a>
            </div>
        }
    </div>

</main>
