@page "/show-invoice-draft/{id:int}"
@model ShowInvoiceDraftModel
@{
}

@section Meta {
    <title>Utkast - @(Model.InvoiceDraft.Id) - @(Branding.WebsiteTitle)</title>
}

@section Header {
    <partial name="_Navbar" model="Model.UserToken" />
}

@await Html.PartialAsync("/Pages/Clients/_Shared/_Invoice.cshtml", Model.UserToken)

<main>

    <h4>
        Utkast
        @if (Model.InvoiceDraft.IsCredit)
        {
            <span class="muted">
                Kreditering
            </span>
        }
        else
        {
            <span class="muted">
                Faktura
            </span>
        }
    </h4>

    <ul class="notice">
        <li>
            @(Model.InvoiceDraft.Customer_Name)
        </li>
        @if (Model.InvoiceDraft.Customer_Address1.HasValue())
        {
            <li>
                @(Model.InvoiceDraft.Customer_Address1)
            </li>
        }
        @if (Model.InvoiceDraft.Customer_Address2.HasValue())
        {
            <li>
                @(Model.InvoiceDraft.Customer_Address2)
            </li>
        }
        <li>
            @(Model.InvoiceDraft.Customer_ZipCode)
            @(Model.InvoiceDraft.Customer_City)
        </li>
        @if (Model.InvoiceDraft.Customer_Country.HasValue())
        {
            <li>
                @(Model.InvoiceDraft.Customer_Country)
            </li>
        }
        <li>
            &nbsp;
        </li>
        <li>
            Fakturadatum:
            &thinsp;
            @if (Model.InvoiceDraft.InvoiceDate == null)
            {
                <a href="/edit-invoice-draft/@(Model.InvoiceDraft.Id)" class="nolink">
                    <span>-</span>
                </a>
            }
            else
            {
                <a href="/edit-invoice-draft/@(Model.InvoiceDraft.Id)">
                    @(Model.InvoiceDraft.InvoiceDate?.ToIso8601())
                </a>
            }
        </li>
        @if (Model.InvoiceDraft.IsCredit)
        {
            <li>
                Villkor
                &thinsp;
                @(Model.InvoiceDraft.PaymentTerms ?? "-")
            </li>
        }
        else
        {
            <li>
                Betalvillkor
                &thinsp;
                @(Model.InvoiceDraft.PaymentTerms ??
                    $"{Defaults.Invoice.PaymentTermDays.Default} dagar netto")
            </li>
        }
        @if (Model.InvoiceDraft.About.HasValue())
        {
            <li>
                &nbsp;
            </li>
            <li>
                Sammanfattning: @(Model.InvoiceDraft.About)
            </li>
        }
    </ul>

    <p>
        <a class="button" href="/edit-invoice-draft/@(Model.InvoiceDraft.Id)">
            Redigera
        </a>
    </p>

    <h5>Artiklar</h5>

    <figure>
        <table>
            <tr>
                <th>Nr</th>
                <th>Artikel</th>
                <th>Kvantitet</th>
                <th>Pris</th>
                <th>Moms-sats</th>
                @* <th>Netto</th>
                <th>Moms</th> *@
                <th>Totalt</th>
                <th></th>
            </tr>
            @foreach (var row in Model.InvoiceDraftRows)
            {
                <tr>
                    <td>
                        @(row.ArticleNumber)
                    </td>
                    <td>
                        <a href="/edit-invoice-draft-row/@(row.Id)">
                            @(row.ArticleName)
                        </a>
                    </td>
                    <td>
                        <a href="/edit-invoice-draft-row/@(row.Id)">
                            @(row.Quantity.ToOptionalDecimals())
                            @(row.Unit)
                        </a>
                    </td>
                    <td>
                        <a href="/edit-invoice-draft-row/@(row.Id)">
                            @(row.UnitPrice.ToSwedish())
                            @(Swedish.Currency.Short)
                        </a>
                    </td>
                    <td>
                        @(row.VatRate.ToOptionalDecimals()) %
                    </td>
                    @* <td>
                        @(row.NetAmount)
                    </td>
                    <td>
                        @(row.VatAmount)
                    </td> *@
                    <td>
                        @(row.TotalAmount)
                    </td>
                    <td>
                        <a href="/remove-invoice-draft-row/@(row.Id)" class="nolink">
                            ❌
                        </a>
                    </td>
                </tr>
            }
        </table>
    </figure>

    <p>
        <a class="button" href="/add-invoice-draft-row/@(Model.InvoiceDraft.Id)">
            Lägg till rad
        </a>
    </p>

    <h5>Summering</h5>

    <figure>
        <table>
            <tr>
                <th class="end-align">Netto</th>
                <th class="end-align">Moms</th>
                <th class="end-align">Avrundning</th>
                <th class="end-align">Totalt</th>
            </tr>
            <tr>
                <td class="end-align">
                    @(Model.InvoiceDraft.NetAmount.ToSwedish())
                </td>
                <td class="end-align">
                    @(Model.InvoiceDraft.VatAmount.ToSwedish())
                </td>
                <td class="end-align">
                    @(Model.InvoiceDraft.TotalRounding.ToSwedish())
                </td>
                <td class="end-align">
                    @(Model.InvoiceDraft.Total.ToSwedish())
                </td>
            </tr>
        </table>
    </figure>
    <br />

    @if (Model.DraftBalanceRows.Count > 0)
    {
        <h5>Kreditering</h5>

        <figure>
            <table>
                <tr>
                    <th class="end-align">Fakturanummer</th>
                    <th class="end-align">Belopp</th>
                </tr>
                @foreach (var row in Model.DraftBalanceRows)
                {
                    <tr>
                        <td class="end-align">
                            <a href="/show-invoice/@(row.InvoiceId)">
                                @(row.InvoiceNumber)
                            </a>
                        </td>
                        <td class="end-align">
                            @(row.Amount.ToSwedish())
                        </td>
                    </tr>
                }
            </table>
        </figure>
    }

    <p>
        <a class="button" href="/approve-invoice-draft/@(Model.InvoiceDraft.Id)">
            Godkänn utkast, skapa faktura
        </a>

        <a class="button" href="/remove-invoice-draft/@(Model.InvoiceDraft.Id)">
            Ta bort
        </a>
    </p>

    <br />

</main>
